name: Deploy naar Cloudflare Pages

# Draait bij elke push naar main, of handmatig via GitHub UI
on:
  push:
    branches:
      - main
  workflow_dispatch:

# ─────────────────────────────────────────────────────────────────────────────
# VEREISTE GITHUB SECRETS  (Instellingen → Secrets and variables → Actions)
# ─────────────────────────────────────────────────────────────────────────────
# Cloudflare:
#   CLOUDFLARE_API_TOKEN     — API-token met "Cloudflare Pages:Edit" rechten
#   CLOUDFLARE_ACCOUNT_ID    — Te vinden op cloudflare.com → rechter zijbalk
#
# AllUnited (nodig tijdens build voor pre-rendered lesrooster):
#   ALLUNITED_API_URL
#   ALLUNITED_CLIENT_ID
#   ALLUNITED_API_KEY
#   ALLUNITED_SECTION
#   ALLUNITED_QUERY_ID
#
# Freescout (nodig tijdens build én runtime voor formulierverwerking):
#   FREESCOUT_API_URL
#   FREESCOUT_API_KEY
#   FREESCOUT_MAILBOX_WIJZIGING
#   FREESCOUT_MAILBOX_OPZEGGING
#   FREESCOUT_MAILBOX_CONTACT
#   FREESCOUT_MAILBOX_KAMP
#   FREESCOUT_MAILBOX_KAMP_TEAMLIDEN
#   FREESCOUT_MAILBOX_ICT
#   FREESCOUT_MAILBOX_CK
#   FREESCOUT_MAILBOX_KLEDING
#
# ─────────────────────────────────────────────────────────────────────────────
# VEREISTE CODEWIJZIGING VOOR RUNTIME API-ROUTES
# ─────────────────────────────────────────────────────────────────────────────
# De huidige adapter (@astrojs/node) draait als Node.js-server en is
# NIET compatibel met Cloudflare Pages. Vervang dit voor volledige SSR-
# ondersteuning (inclusief /api/freescout-submit):
#
#   1. Installeer de Cloudflare adapter:
#      npm install @astrojs/cloudflare
#      npm uninstall @astrojs/node
#
#   2. Pas astro.config.mjs aan:
#      import cloudflare from '@astrojs/cloudflare';
#      export default defineConfig({
#        output: 'static',
#        adapter: cloudflare(),
#        ...
#      });
#
#   3. Zet in Cloudflare Pages → Settings → Functions:
#      Compatibility flags: nodejs_compat
#      Compatibility date: 2024-09-23 (of nieuwer)
#
#   4. Stel de Freescout runtime-variabelen in via:
#      Cloudflare Pages → Settings → Environment variables
#      (zelfde lijst als de FREESCOUT_* secrets hierboven)
# ─────────────────────────────────────────────────────────────────────────────

env:
  CF_PROJECT_NAME: hgv-hengelo   # Cloudflare Pages projectnaam (lowercase, koppelteken)

jobs:
  deploy:
    name: Bouwen en deployen
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      # ── 1. Code ophalen ────────────────────────────────────────────────────
      - name: Code ophalen
        uses: actions/checkout@v4

      # ── 2. Node.js instellen ───────────────────────────────────────────────
      - name: Node.js instellen
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'

      # ── 3. Afhankelijkheden installeren ────────────────────────────────────
      - name: Afhankelijkheden installeren
        run: npm ci

      # ── 4. Site bouwen ─────────────────────────────────────────────────────
      - name: Site bouwen
        run: npm run build
        env:
          # AllUnited — wordt gebruikt tijdens de build voor het lesrooster
          ALLUNITED_API_URL: ${{ secrets.ALLUNITED_API_URL }}
          ALLUNITED_CLIENT_ID: ${{ secrets.ALLUNITED_CLIENT_ID }}
          ALLUNITED_API_KEY: ${{ secrets.ALLUNITED_API_KEY }}
          ALLUNITED_SECTION: ${{ secrets.ALLUNITED_SECTION }}
          ALLUNITED_QUERY_ID: ${{ secrets.ALLUNITED_QUERY_ID }}
          # Freescout — nodig tijdens build voor compilatie van de API-route
          FREESCOUT_API_URL: ${{ secrets.FREESCOUT_API_URL }}
          FREESCOUT_API_KEY: ${{ secrets.FREESCOUT_API_KEY }}
          FREESCOUT_MAILBOX_WIJZIGING: ${{ secrets.FREESCOUT_MAILBOX_WIJZIGING }}
          FREESCOUT_MAILBOX_OPZEGGING: ${{ secrets.FREESCOUT_MAILBOX_OPZEGGING }}
          FREESCOUT_MAILBOX_CONTACT: ${{ secrets.FREESCOUT_MAILBOX_CONTACT }}
          FREESCOUT_MAILBOX_KAMP: ${{ secrets.FREESCOUT_MAILBOX_KAMP }}
          FREESCOUT_MAILBOX_KAMP_TEAMLIDEN: ${{ secrets.FREESCOUT_MAILBOX_KAMP_TEAMLIDEN }}
          FREESCOUT_MAILBOX_ICT: ${{ secrets.FREESCOUT_MAILBOX_ICT }}
          FREESCOUT_MAILBOX_CK: ${{ secrets.FREESCOUT_MAILBOX_CK }}
          FREESCOUT_MAILBOX_KLEDING: ${{ secrets.FREESCOUT_MAILBOX_KLEDING }}

      # ── 5. Cloudflare Pages project aanmaken indien het niet bestaat ────────
      - name: Cloudflare Pages project aanmaken indien nodig
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: |
          echo "Controleren of project '$CF_PROJECT_NAME' bestaat..."

          RESPONSE=$(curl -s \
            -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
            "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects/$CF_PROJECT_NAME")

          SUCCESS=$(echo "$RESPONSE" | jq -r '.success')

          if [ "$SUCCESS" = "true" ]; then
            echo "Project bestaat al, verder met deployment."
          else
            echo "Project niet gevonden, aanmaken..."

            CREATE=$(curl -s -X POST \
              -H "Authorization: Bearer $CLOUDFLARE_API_TOKEN" \
              -H "Content-Type: application/json" \
              -d "{\"name\": \"$CF_PROJECT_NAME\", \"production_branch\": \"main\"}" \
              "https://api.cloudflare.com/client/v4/accounts/$CLOUDFLARE_ACCOUNT_ID/pages/projects")

            if [ "$(echo "$CREATE" | jq -r '.success')" = "true" ]; then
              echo "Project '$CF_PROJECT_NAME' aangemaakt."
            else
              echo "Fout bij aanmaken van het project:"
              echo "$CREATE" | jq '.errors'
              exit 1
            fi
          fi

      # ── 6. Deployen naar Cloudflare Pages ──────────────────────────────────
      - name: Deployen naar Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist/ --project-name=${{ env.CF_PROJECT_NAME }} --branch=main
