name: Dependabot auto-merge

# pull_request_target draait met de rechten van de basisbranch,
# zodat reguliere repository secrets (PAT_TOKEN) beschikbaar zijn.
on:
  pull_request_target:
    branches: [main]
    types: [opened, synchronize, reopened, ready_for_review]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    name: Goedkeuren en auto-merge inschakelen
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'

    steps:
      # ── 1. Metadata ophalen ────────────────────────────────────────────────
      - name: Dependabot metadata ophalen
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # ── 2. Goedkeuren als code owner ───────────────────────────────────────
      # PAT_TOKEN is een Personal Access Token van @Rubenrikk (code owner).
      # Aanmaken: GitHub → Settings → Developer settings → Personal access tokens
      # Opslaan:  Repo → Settings → Secrets and variables → Actions → PAT_TOKEN
      # Minimale scope: repo (of pull_requests: write + contents: read)
      - name: PR goedkeuren als code owner
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: |
          gh pr review "$PR_URL" \
            --approve \
            --body "✅ Automatisch goedgekeurd: Dependabot dependency update (update-type: ${{ steps.metadata.outputs.update-type }})."

      # ── 3. Auto-merge inschakelen ──────────────────────────────────────────
      # De PR wordt automatisch gemerged zodra alle vereiste checks slagen.
      - name: Auto-merge inschakelen
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_URL: ${{ github.event.pull_request.html_url }}
        run: gh pr merge --auto --squash "$PR_URL"
